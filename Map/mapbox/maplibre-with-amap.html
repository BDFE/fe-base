<!DOCTYPE html>
<html lang="zh" style="width: 100%; height: 100%; margin: 0; padding: 0">
  <head>
    <meta charset="UTF-8" />
    <title>mapbox整合高德、百度地图</title>

    <!--    mapbox-->
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />

    <script src="https://cdn.maptiler.com/maptiler-sdk-js/latest/maptiler-sdk.umd.min.js"></script>
    <link
      href="https://cdn.maptiler.com/maptiler-sdk-js/latest/maptiler-sdk.css"
      rel="stylesheet"
    />

    <!-- 加载地图JSAPI脚本 -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=096ec74ca9fc2c8f7958c064fc918827"></script>
  </head>
  <body
    style="width: 100%; height: 100%; margin: 0; padding: 0; position: relative"
  >
    <div
      id="amap"
      style="
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      "
    ></div>
    <div
      id="mapbox-map"
      style="
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 3;
        opacity: 0.4;
      "
    ></div>

    <div
      id="info-panel"
      style="
        position: absolute;
        z-index: 4;
        top: 10px;
        left: 10px;
        padding: 5px;
        background-color: rebeccapurple;
      "
    ></div>
    <script>
      const { PI } = Math;
      // 球体长半径
      const SPHERE_RADIUS = 6378245.0;
      // 扁率
      const FLATNESS = 0.00669342162296594323;
      const ER = 20037508.342789;

      function transformLat(inputLng, inputLat) {
        const lat = +inputLat;
        const lng = +inputLng;
        let ret =
          -100.0 +
          2.0 * lng +
          3.0 * lat +
          0.2 * lat * lat +
          0.1 * lng * lat +
          0.2 * Math.sqrt(Math.abs(lng));
        ret +=
          ((20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) *
            2.0) /
          3.0;
        ret +=
          ((20.0 * Math.sin(lat * PI) + 40.0 * Math.sin((lat / 3.0) * PI)) *
            2.0) /
          3.0;
        ret +=
          ((160.0 * Math.sin((lat / 12.0) * PI) +
            320 * Math.sin((lat * PI) / 30.0)) *
            2.0) /
          3.0;
        return ret;
      }

      function transformLng(inputLng, inputLat) {
        const lat = +inputLat;
        const lng = +inputLng;
        let ret =
          300.0 +
          lng +
          2.0 * lat +
          0.1 * lng * lng +
          0.1 * lng * lat +
          0.1 * Math.sqrt(Math.abs(lng));
        ret +=
          ((20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) *
            2.0) /
          3.0;
        ret +=
          ((20.0 * Math.sin(lng * PI) + 40.0 * Math.sin((lng / 3.0) * PI)) *
            2.0) /
          3.0;
        ret +=
          ((150.0 * Math.sin((lng / 12.0) * PI) +
            300.0 * Math.sin((lng / 30.0) * PI)) *
            2.0) /
          3.0;
        return ret;
      }

      /**
       * 判断是否在国内，不在国内则不做偏移
       * @param lng
       * @param lat
       * @returns {boolean}
       */
      function outOfChina(inputLng, inputLat) {
        const lat = +inputLat;
        const lng = +inputLng;
        // 纬度 3.86~53.55, 经度 73.66~135.05
        return !(lng > 73.66 && lng < 135.05 && lat > 3.86 && lat < 53.55);
      }

      /**
       * wgs84 转 gcj02
       * 离线转换
       * @param inputLng
       * @param inputLat
       * @returns {number[]}
       */
      function wgs84ToGcj02(inputLng, inputLat) {
        const lat = +inputLat;
        const lng = +inputLng;
        if (outOfChina(lng, lat)) {
          return [lng, lat];
        } else {
          let dLat = transformLat(lng - 105.0, lat - 35.0);
          let dLng = transformLng(lng - 105.0, lat - 35.0);
          const radLat = (lat / 180.0) * PI;
          let magic = Math.sin(radLat);
          magic = 1 - FLATNESS * magic * magic;
          const sqrtMagic = Math.sqrt(magic);
          dLat =
            (dLat * 180.0) /
            (((SPHERE_RADIUS * (1 - FLATNESS)) / (magic * sqrtMagic)) * PI);
          dLng =
            (dLng * 180.0) /
            ((SPHERE_RADIUS / sqrtMagic) * Math.cos(radLat) * PI);
          const mgLat = lat + dLat;
          const mgLng = lng + dLng;
          return [mgLng, mgLat];
        }
      }

      const dongdajie = [40.081086, 116.363319].reverse();

      maplibregl.accessToken =
        "pk.eyJ1IjoiZGFuaWVsdGFvMTk5MyIsImEiOiJjbGN6cGQwZ2YxMDcxM3B0Z2llZ2lseXJtIn0.CdlmG8V-1D18NuLP5QcvSQ";
      const center = [114.18088588361525, 30.55405768340087];
      const zoom = 11;
      const mapboxMap = new maplibregl.Map({
        container: "mapbox-map",
        // style: {
        //   name: "blank",
        //   version: 8,
        //   sources: {},
        //   layers: [],
        // },
        style:
          "https://api.maptiler.com/maps/streets-v2/style.json?key=mUPP5KIZNCInRM9vJ9MH",
        // style: "mapbox://styles/mapbox/satellite-streets-v11",
        // style: "mapbox://styles/mapbox/streets-v12",
        center: dongdajie,
        zoom: zoom,
        pitch: 0,
        maxPitch: 0,
        maxZoom: 17,
        dragRotate: false,
      });

      var marker = new maplibregl.Marker({
        // draggable: true,
      })
        .setLngLat(dongdajie)
        .addTo(mapboxMap);


      const aMapCenter = wgs84ToGcj02(center[0], center[1]);

      const amapMap = new AMap.Map("amap", {
        viewMode: "3D",
        pitch: 0,
        zoom: zoom + 1, //初始化地图层级
        center: aMapCenter, //初始化地图中心点
      });

      function linkAMap() {
        const mapboxZoom = mapboxMap.getZoom() + 1;
        const mapboxCenter = mapboxMap.getCenter();
        amapMap.setZoom(mapboxZoom);
        amapMap.setCenter(wgs84ToGcj02(mapboxCenter.lng, mapboxCenter.lat));

        document.getElementById("info-panel").innerText =
          "zoom:" +
          mapboxZoom +
          ",lng:" +
          mapboxCenter.lng +
          ",lat:" +
          mapboxCenter.lat;
      }

      mapboxMap.on("move", () => {
        linkAMap();
      });

      mapboxMap.on("zoom", () => {
        linkAMap();
      });
    </script>
  </body>
</html>
