<html>
  <head>
    <title>Interleaving deck.gl with Mapbox Layers</title>
    <script src="https://unpkg.com/deck.gl@^8.8.0/dist.min.js"></script>
    <!-- <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.13.0/mapbox-gl.css"
      rel="stylesheet"
    /> -->

    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
  </head>

  <body style="margin: 0"></body>

  <script type="text/javascript">
    const center = [-122.486052, 37.830348];

    const {
      MapboxLayer,
      ScatterplotLayer,
      ArcLayer,
      COORDINATE_SYSTEM,
      PointCloudLayer,
    } = deck;
    
    console.log('COORDINATE_SYSTEM: ', COORDINATE_SYSTEM);

    // One million points
    const SAMPLE_SIZE = 1e6;
    const SURFACE_EQUATION = (x, y) => (Math.sin(x * x + y * y) * x) / Math.PI;
    const EPSILON = 1e-4;

    const points = [];
    const dim = Math.sqrt(SAMPLE_SIZE);

    function getPosition(u, v) {
      const x = (u - 1 / 2) * Math.PI * 2;
      const y = (v - 1 / 2) * Math.PI * 2;
      const z = SURFACE_EQUATION(x, y);

      return [x, y, z];
    }

    function getNormal(u, v) {
      const p0 = getPosition(u - EPSILON, v - EPSILON);
      const p1 = getPosition(u + EPSILON, v + EPSILON);

      const nx = (p1[1] - p0[1]) * (p1[2] - p0[2]);
      const ny = (p1[2] - p0[2]) * (p1[0] - p0[0]);
      const nz = (p1[0] - p0[0]) * (p1[1] - p0[1]);

      return [nx, ny, nz];
    }

    for (let i = 0; i < dim; i++) {
      for (let j = 0; j < dim; j++) {
        const u = i / (dim - 1);
        const v = j / (dim - 1);

        const p = getPosition(u, v);
        const n = getNormal(u, v);
        points.push({
          position: p,
          normal: n,
          color: [u * 128, v * 128, p[2] * 255],
        });
      }
    }

    var map = new maplibregl.Map({
      container: document.body,
      style: { version: 8, sources: {}, layers: [] },
      // "https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL",
      center: center,
      zoom: 15,
      pitch: 60,
    });

    console.log("points: ", center, points);

    map.on("load", () => {
      map.addLayer(
        new MapboxLayer({
          id: "deckgl-PointCloudLayer",
          type: PointCloudLayer,
          //REPLACE THIS WITH THE URL OF THE FILE
          data: points,
          coordinateSystem: COORDINATE_SYSTEM.METER_OFFSETS,
          coordinateOrigin: center,
          radiusPixels: 4,
          getPosition: (d) => d.position,
          getNormal: (d) => d.normal,
          getColor: (d) => d.color,
          sizeUnits: "pixels",
          pointSize: 20,
        })
      );
      map.addLayer(
        new MapboxLayer({
          id: "deckgl-arc",
          type: ArcLayer,
          data: [{ source: center, target: [center[0], center[1] + 0.1] }],
          getSourcePosition: (d) => d.source,
          getTargetPosition: (d) => d.target,
          getSourceColor: [255, 208, 0],
          getTargetColor: [0, 128, 255],
          getWidth: 8,
        })
      );
    });
  </script>
</html>
